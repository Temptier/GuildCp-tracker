<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Guild Leaderboards - GuildPower Tracker Pro</title>
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@300;400;500;600;700&display=swap');
    .medieval-font { font-family: 'MedievalSharp', cursive; }
    .class-badge { 
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .fade-in {
      animation: fadeIn 0.4s ease-in-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    th { cursor: pointer; }
  </style>
</head>
<body class="bg-gray-900 text-white font-['Inter']">

  <!-- Navigation -->
  <nav class="bg-gray-800 py-4 px-6 flex justify-between items-center">
    <div class="flex items-center space-x-2">
      <a href="index.html" class="flex items-center space-x-2">
        <i data-feather="arrow-left" class="text-yellow-400"></i>
        <h1 class="text-xl medieval-font">GuildPower Tracker Pro</h1>
      </a>
    </div>
  </nav>

<!-- Leaderboard Section -->
  <section class="py-12">
    <div class="container mx-auto px-6">
      <h2 class="text-4xl font-bold mb-8 text-center medieval-font">Guild Leaderboards</h2>

      <!-- Top Summary Cards -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg text-center">
          <p class="text-gray-400">Total Members</p>
          <p id="totalMembers" class="text-3xl font-bold">0</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg text-center">
          <p class="text-gray-400">Average CP</p>
          <p id="avgCP" class="text-3xl font-bold">0</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg text-center">
          <p class="text-gray-400">Top Growth (This Week)</p>
          <p id="topGrowth" class="text-3xl font-bold text-green-400">0</p>
        </div>
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg text-center">
          <p class="text-gray-400">Active Classes</p>
          <p id="activeClasses" class="text-3xl font-bold">0</p>
        </div>
      </div>

      <!-- Leaderboard Table -->
      <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
        <h3 class="text-2xl font-bold mb-6">Current Rankings</h3>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="border-b border-gray-700">
                <th class="py-3 text-left">Rank</th>
                <th class="py-3 text-left">Member</th>
                <th class="py-3 text-left" onclick="sortLeaderboard('class')">Class</th>
                <th class="py-3 text-left" onclick="sortLeaderboard('cp')">Current CP</th>
                <th class="py-3 text-left" onclick="sortLeaderboard('growth')">Weekly Growth</th>
                <th class="py-3 text-left" onclick="sortLeaderboard('week')">Last Updated</th>
              </tr>
            </thead>
            <tbody id="leaderboardBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

<script>
  // --- ðŸ”¥ Firebase Setup ---
  const firebaseConfig = {
    apiKey: "AIzaSyDoim277EKmZDh0TnbZbK5OXy2GdVW-d84",
    authDomain: "guildcombatpower.firebaseapp.com",
    projectId: "guildcombatpower",
    storageBucket: "guildcombatpower.firebasestorage.app",
    messagingSenderId: "862355543279",
    appId: "1:862355543279:web:e7d7c1b5ee1f3ba89f371a"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const membersRef = db.collection('members');

  // --- Helper: Format week label "Oct-19 - Oct-25" ---
  function formatWeekLabel(sunday, saturday) {
    const options = { month: 'short', day: 'numeric' };
    return `${sunday.toLocaleDateString('en-US', options)} - ${saturday.toLocaleDateString('en-US', options)}`;
  }

  // --- Helper: Get current Sunday-to-Saturday week label ---
  function getCurrentWeekLabel() {
    const today = new Date();
    const day = today.getDay(); // 0 = Sunday
    const sunday = new Date(today);
    sunday.setDate(today.getDate() - day);
    const saturday = new Date(sunday);
    saturday.setDate(sunday.getDate() + 6);
    return formatWeekLabel(sunday, saturday);
  }

  // --- Leaderboard Data & Sorting ---
  let currentSort = { key: 'rank', asc: true };

  async function loadLeaderboard() {
    const snapshot = await membersRef.get();
    let members = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    if (!members.length) return;

    // Sort by currentSort
    members.sort((a, b) => {
      let valA, valB;
      switch (currentSort.key) {
        case 'class':
          valA = a.class || ''; valB = b.class || '';
          return currentSort.asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
        case 'cp':
          valA = a.cp || 0; valB = b.cp || 0;
          return currentSort.asc ? valA - valB : valB - valA;
        case 'growth':
          valA = a.growth || 0; valB = b.growth || 0;
          return currentSort.asc ? valA - valB : valB - valA;
        case 'week':
          valA = a.weeklyCP?.slice(-1)[0]?.week || ''; 
          valB = b.weeklyCP?.slice(-1)[0]?.week || '';
          return currentSort.asc ? valA.localeCompare(valB) : valB.localeCompare(valA);
        default: // rank
          valA = a.rank || 0; valB = b.rank || 0;
          return currentSort.asc ? valA - valB : valB - valA;
      }
    });

    // Update ranks in Firestore
    members.forEach((m, i) => {
      membersRef.doc(m.id).update({ rank: i + 1 });
    });

    // Update summary cards
    const totalMembers = members.length;
    const avgCP = Math.round(members.reduce((a, b) => a + (b.cp || 0), 0) / totalMembers);
    const topGrowth = Math.max(...members.map(m => m.growth || 0));
    const activeClasses = [...new Set(members.map(m => m.class))].length;

    document.getElementById("totalMembers").textContent = totalMembers;
    document.getElementById("avgCP").textContent = avgCP.toLocaleString();
    document.getElementById("topGrowth").textContent = topGrowth.toLocaleString();
    document.getElementById("activeClasses").textContent = activeClasses;

    // Render table
    const tbody = document.getElementById("leaderboardBody");
    tbody.innerHTML = members.map(m => {
      const latestWeekEntry = m.weeklyCP?.slice(-1)[0] || {};
      const weekLabel = latestWeekEntry.week || getCurrentWeekLabel();
      return `
        <tr class="border-b border-gray-700 hover:bg-gray-700 fade-in">
          <td class="py-3 font-bold">#${m.rank || '-'}</td>
          <td class="py-3 flex items-center space-x-3">
            <img src="${m.avatar || 'https://i.imgur.com/Bo3ZY5vm.jpg'}" class="w-10 h-10 rounded-full">
            <span>${m.name}</span>
          </td>
          <td class="py-3"><span class="class-badge ${m.classColor || 'bg-gray-500'}">${m.class}</span></td>
          <td class="py-3 font-bold">${(latestWeekEntry.cp ?? m.cp ?? 0).toLocaleString()}</td>
          <td class="py-3 ${latestWeekEntry.growth >= 0 ? 'text-green-400' : 'text-red-400'} font-bold">
            ${latestWeekEntry.growth >= 0 ? '+' : ''}${(latestWeekEntry.growth ?? m.growth ?? 0).toLocaleString()}
          </td>
          <td class="py-3">${weekLabel}</td>
        </tr>
      `;
    }).join('');

    feather.replace();
  }

  // --- Sort Function ---
  function sortLeaderboard(key) {
    if (currentSort.key === key) currentSort.asc = !currentSort.asc;
    else currentSort = { key, asc: true };
    loadLeaderboard();
  }

  loadLeaderboard();
  setInterval(loadLeaderboard, 15000);
</script>

!-- ðŸ“Š Analytics Section -->
  <section class="py-12">
    <div class="container mx-auto px-6">
      <div class="bg-gray-800 rounded-xl p-6 shadow-lg mb-12">
        <h3 class="text-2xl font-bold mb-6">Class Average Combat Power</h3>
        <div class="h-96">
          <canvas id="classAvgChart"></canvas>
        </div>
      </div>

<script>
  // --- ðŸ“Š Charts for Analytics ---
  async function loadAnalytics() {
    const snapshot = await membersRef.get();
    const members = snapshot.docs.map(doc => doc.data());
    if (!members.length) return;

    // ----- Class Average CP -----
    const classGroups = {};
    members.forEach(m => {
      if (!classGroups[m.class]) classGroups[m.class] = [];
      classGroups[m.class].push(m.cp || 0);
    });

    const classLabels = Object.keys(classGroups);
    const classAverages = classLabels.map(c =>
      Math.round(classGroups[c].reduce((a, b) => a + b, 0) / classGroups[c].length)
    );

    const classCtx = document.getElementById("classAvgChart").getContext("2d");
    new Chart(classCtx, {
      type: "bar",
      data: {
        labels: classLabels,
        datasets: [{
          label: "Average Combat Power",
          data: classAverages,
          backgroundColor: "rgba(59,130,246,0.6)",
          borderColor: "#3b82f6",
          borderWidth: 2,
          borderRadius: 8
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: true, grid: { color: "rgba(255,255,255,0.1)" } },
          x: { grid: { color: "rgba(255,255,255,0.1)" } }
        }
      }
    });

    // ----- Guild Weekly Growth (Last 4 Weeks) -----
    const weekLabelsSet = new Set();
    const weekTotals = {};

    members.forEach(m => {
      (m.weeklyCP || []).forEach(w => {
        weekLabelsSet.add(w.week);
        if (!weekTotals[w.week]) weekTotals[w.week] = 0;
        weekTotals[w.week] += w.cp || 0;
      });
    });

    const weekLabels = Array.from(weekLabelsSet).sort(); // sorted chronologically
    const weeklyValues = weekLabels.map(week => Math.round((weekTotals[week] || 0) / members.length));

    const weeklyCtx = document.getElementById("weeklyGrowthChart").getContext("2d");
    new Chart(weeklyCtx, {
      type: "line",
      data: {
        labels: weekLabels,
        datasets: [{
          label: "Average CP Growth",
          data: weeklyValues,
          borderColor: "#10b981",
          backgroundColor: "rgba(16,185,129,0.15)",
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: {
          y: { beginAtZero: false, grid: { color: "rgba(255,255,255,0.1)" } },
          x: { grid: { color: "rgba(255,255,255,0.1)" } }
        }
      }
    });
  }

  // Load analytics after leaderboard loads
  setTimeout(loadAnalytics, 2000);
</script>
</body>
</html>