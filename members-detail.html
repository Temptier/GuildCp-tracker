<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Member Detail - GuildPower Tracker</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@300;400;500;600;700&display=swap');
    .medieval-font { font-family: 'MedievalSharp', cursive; }
    .class-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
    }
    .btn {
      padding: 0.5rem 1rem;
      border-radius: 0.5rem;
      font-weight: 600;
      transition: background-color 0.2s;
    }
  </style>
</head>

<body class="bg-gray-900 text-white font-['Inter']">

  <!-- Navigation -->
  <nav class="bg-gray-800 py-4 px-6 flex justify-between items-center">
    <div class="flex items-center space-x-2">
      <a href="index.html" class="flex items-center space-x-2">
        <i data-feather="arrow-left" class="text-yellow-400"></i>
        <h1 class="text-xl medieval-font">GuildPower Tracker</h1>
      </a>
    </div>
  </nav>

  <!-- Member Detail Section -->
  <section class="py-12">
    <div class="container mx-auto px-6">
      <div class="max-w-4xl mx-auto">

        <!-- Member Header -->
        <div id="member-header" class="bg-gray-800 rounded-xl p-8 shadow-lg mb-8">
          <div class="flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-y-0 md:space-x-8">
            <img id="member-avatar" src="" alt="Member Avatar" class="w-32 h-32 rounded-full border-4 border-yellow-400">
            <div class="flex-1 text-center md:text-left">
              <h2 id="member-name" class="text-4xl font-bold mb-2 medieval-font">Member Name</h2>
              <span id="member-class" class="class-badge bg-blue-500 text-white text-lg">Class</span>
              <div class="mt-6 grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center">
                  <p class="text-gray-400">Current CP</p>
                  <p id="member-cp" class="text-2xl font-bold">0</p>
                </div>
                <div class="text-center">
                  <p class="text-gray-400">Weekly Growth</p>
                  <p id="member-growth" class="text-2xl font-bold text-green-400">0</p>
                </div>
                <div class="text-center">
                  <p class="text-gray-400">Rank</p>
                  <p id="member-rank" class="text-2xl font-bold">#-</p>
                </div>
                <div class="text-center">
                  <p class="text-gray-400">Member Since</p>
                  <p id="member-since" class="text-xl font-bold">Week 1</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Update/Delete Controls -->
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg mb-8">
          <h3 class="text-xl font-bold mb-4">Update Combat Power</h3>
          <div class="flex flex-col sm:flex-row gap-4">
            <input id="update-cp-input" type="number" placeholder="Enter new CP" class="w-full px-4 py-2 rounded-lg bg-gray-700 focus:outline-none focus:ring-2 focus:ring-yellow-400">
            <button id="update-cp-btn" class="btn bg-yellow-500 text-gray-900 hover:bg-yellow-400">Update</button>
            <button id="delete-member-btn" class="btn bg-red-600 hover:bg-red-500">Delete</button>
          </div>
        </div>

        <!-- Progress Chart -->
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg mb-8">
          <h3 class="text-xl font-bold mb-6">Combat Power Progression</h3>
          <div class="h-80">
            <canvas id="memberProgressChart"></canvas>
          </div>
        </div>

        <!-- Weekly Data Table -->
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-6">Weekly CP History</h3>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="border-b border-gray-700">
                  <th class="text-left py-3">Week</th>
                  <th class="text-left py-3">Combat Power</th>
                  <th class="text-left py-3">Growth</th>
                  <th class="text-left py-3">Rank</th>
                </tr>
              </thead>
              <tbody id="weekly-history-body">
                <!-- Filled dynamically -->
              </tbody>
            </table>
          </div>
        </div>

      </div>
    </div>
  </section>

<!-- Firebase Logic & Chart -->
    <script>
      // Firebase config (same as index)
      const firebaseConfig = {
        apiKey: "AIzaSyDoim277EKmZDh0TnbZbK5OXy2GdVW-d84",
        authDomain: "guildcombatpower.firebaseapp.com",
        projectId: "guildcombatpower",
        storageBucket: "guildcombatpower.firebasestorage.app",
        messagingSenderId: "862355543279",
        appId: "1:862355543279:web:e7d7c1b5ee1f3ba89f371a"
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const membersRef = db.collection('members');

      const urlParams = new URLSearchParams(window.location.search);
      const memberId = urlParams.get('id');
      if (!memberId) {
        alert("No member selected.");
        window.location.href = "index.html";
      }

      // Elements
      const nameEl = document.getElementById('member-name');
      const classEl = document.getElementById('member-class');
      const cpEl = document.getElementById('member-cp');
      const growthEl = document.getElementById('member-growth');
      const rankEl = document.getElementById('member-rank');
      const sinceEl = document.getElementById('member-since');
      const avatarEl = document.getElementById('member-avatar');
      const weeklyBody = document.getElementById('weekly-history-body');

      const updateBtn = document.getElementById('update-cp-btn');
      const deleteBtn = document.getElementById('delete-member-btn');
      const updateInput = document.getElementById('update-cp-input');

      // Chart setup
      const ctx = document.getElementById('memberProgressChart').getContext('2d');
      const memberChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [{
            label: 'Combat Power',
            data: [],
            borderColor: '#fbbf24',
            backgroundColor: 'rgba(251,191,36,0.1)',
            tension: 0.3,
            fill: true
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: { grid: { color: 'rgba(255,255,255,0.1)' } },
            y: { grid: { color: 'rgba(255,255,255,0.1)' } }
          },
          plugins: { legend: { display: false } }
        }
      });

      // Fetch & render member data
      function loadMember() {
        membersRef.doc(memberId).get().then(doc => {
          if (!doc.exists) return alert("Member not found.");
          const data = doc.data();

          nameEl.textContent = data.name;
          classEl.textContent = data.class;
          classEl.className = `class-badge ${data.classColor} text-white text-lg`;
          cpEl.textContent = data.cp.toLocaleString();
          growthEl.textContent = (data.growth >= 0 ? "+" : "") + data.growth.toLocaleString();
          growthEl.classList.toggle('text-green-400', data.growth >= 0);
          growthEl.classList.toggle('text-red-400', data.growth < 0);
          rankEl.textContent = data.rank ? "#" + data.rank : "-";
          sinceEl.textContent = data.weeklyCP?.[0]?.week || "Week 1";
          avatarEl.src = data.avatar || "https://i.imgur.com/I4Rku2cm.jpg";

          // Weekly history table
          weeklyBody.innerHTML = "";
          data.weeklyCP?.forEach(entry => {
            const row = document.createElement("tr");
            row.className = "border-b border-gray-700";
            row.innerHTML = `
              <td class="py-2">${entry.week}</td>
              <td class="py-2">${entry.cp.toLocaleString()}</td>
              <td class="py-2 ${entry.growth >= 0 ? 'text-green-400' : 'text-red-400'}">
                ${(entry.growth >= 0 ? "+" : "") + entry.growth.toLocaleString()}
              </td>
              <td class="py-2">${entry.rank || '-'}</td>
            `;
            weeklyBody.appendChild(row);
          });

          // Chart update
          const labels = data.weeklyCP.map(e => e.week);
          const cpValues = data.weeklyCP.map(e => e.cp);
          memberChart.data.labels = labels;
          memberChart.data.datasets[0].data = cpValues;
          memberChart.update();
        });
      }

      loadMember();

      // Update CP logic (with 4-week cap)
      updateBtn.addEventListener('click', async () => {
        const newCP = parseInt(updateInput.value);
        if (isNaN(newCP)) return alert("Enter a valid number.");
        const docSnap = await membersRef.doc(memberId).get();
        if (!docSnap.exists) return alert("Member not found.");

        const data = docSnap.data();
        const oldCP = data.cp || 0;
        const growth = newCP - oldCP;
        let weekly = data.weeklyCP || [];

        // Weekly entry
        const weekNum = weekly.length ? parseInt(weekly[weekly.length - 1].week.split(" ")[1]) + 1 : 1;
        const newEntry = { week: "Week " + weekNum, cp: newCP, growth: growth, rank: data.rank || "-" };
        weekly.push(newEntry);

        // 🔁 Keep only last 4 weeks
        if (weekly.length > 4) weekly = weekly.slice(-4);

        await membersRef.doc(memberId).update({
          cp: newCP,
          growth: growth,
          weeklyCP: weekly
        });

        alert(`✅ CP Updated! Growth: ${growth >= 0 ? "+" : ""}${growth}`);
        updateInput.value = "";
        loadMember();
      });

      // Delete Member
      deleteBtn.addEventListener('click', async () => {
        if (!confirm("Are you sure you want to delete this member?")) return;
        await membersRef.doc(memberId).delete();
        alert("🗑️ Member deleted!");
        window.location.href = "index.html";
      });

      feather.replace();
    </script>
  </body>
</html>