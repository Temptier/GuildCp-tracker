<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Member Detail - GuildPower Tracker Pro</title>
  <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@300;400;500;600;700&display=swap');
    .medieval-font { font-family: 'MedievalSharp', cursive; }
  </style>
</head>

<body class="bg-gray-900 text-white font-['Inter']">
  <!-- Navbar -->
  <nav class="bg-gray-800 py-4 px-6 flex justify-between items-center shadow-lg">
    <a href="index.html" class="flex items-center space-x-2 text-yellow-400 hover:underline">
      <i data-feather="arrow-left"></i>
      <h1 class="text-xl medieval-font">Back to Leaderboard</h1>
    </a>
  </nav>

  <!-- Member Detail -->
  <section class="py-10 px-6">
    <div class="max-w-4xl mx-auto space-y-8">

      <!-- Profile Header -->
      <div class="bg-gray-800 rounded-xl p-8 shadow-lg flex flex-col md:flex-row items-center md:items-start space-y-6 md:space-y-0 md:space-x-8">
        <img id="avatar" src="" alt="Avatar" class="w-32 h-32 rounded-full border-4 border-yellow-400">
        <div class="text-center md:text-left">
          <h2 id="memberName" class="text-4xl font-bold mb-2 medieval-font">Loading...</h2>
          <span id="memberClass" class="inline-block bg-blue-500 text-white px-4 py-1 rounded-full text-sm font-bold uppercase">Class</span>
        </div>
      </div>

      <!-- Update/Delete Controls -->
      <div class="bg-gray-800 rounded-xl p-6 shadow-lg space-y-4">
        <h3 class="text-xl font-bold mb-4">‚öôÔ∏è Manage Member</h3>
        <input id="updateCP" type="number" placeholder="Enter new Combat Power" class="w-full p-2 rounded bg-gray-700 text-white" />
        <div class="flex space-x-4">
          <button id="updateBtn" class="bg-green-500 hover:bg-green-600 text-black font-bold py-2 px-4 rounded w-1/2">
            Update CP
          </button>
          <button id="deleteBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded w-1/2">
            Delete Member
          </button>
        </div>
      </div>

      <!-- Chart -->
      <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
        <h3 class="text-xl font-bold mb-6">üìà Combat Power Progression</h3>
        <div class="h-80">
          <canvas id="progressChart"></canvas>
        </div>
      </div>

      <!-- Weekly CP History -->
      <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
        <h3 class="text-xl font-bold mb-6">üìú Weekly History</h3>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead>
              <tr class="border-b border-gray-700">
                <th class="text-left py-3">Week</th>
                <th class="text-left py-3">CP</th>
                <th class="text-left py-3">Growth</th>
              </tr>
            </thead>
            <tbody id="historyBody">
              <!-- Filled dynamically -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </section>

  <!-- Firebase & Script -->
  <script>
    // === üî• Firebase Config ===
    const firebaseConfig = {
      apiKey: "AIzaSyDoim277EKmZDh0TnbZbK5OXy2GdVW-d84",
      authDomain: "guildcombatpower.firebaseapp.com",
      projectId: "guildcombatpower",
      storageBucket: "guildcombatpower.firebasestorage.app",
      messagingSenderId: "862355543279",
      appId: "1:862355543279:web:e7d7c1b5ee1f3ba89f371a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const membersRef = db.collection("members");

    // Helper: get URL param
    function getParam(param) {
      return new URLSearchParams(window.location.search).get(param);
    }

    const memberId = getParam("id");
    let memberData = null;

    // Helper: week label
    function getCurrentWeekLabel() {
  const today = new Date();
  const day = today.getDay(); // 0 = Sunday
  const sunday = new Date(today);
  sunday.setDate(today.getDate() - day);
  const saturday = new Date(sunday);
  saturday.setDate(sunday.getDate() + 6);

  const formatLabel = d => {
    const options = { month: 'short', day: 'numeric' };
    return d.toLocaleDateString('en-US', options);
  };

  return `${formatLabel(sunday)} - ${formatLabel(saturday)}`;
}

    // === üßæ Load member data ===
    async function loadMember() {
      const doc = await membersRef.doc(memberId).get();
      if (!doc.exists) {
        alert("Member not found!");
        window.location.href = "index.html";
        return;
      }
      memberData = doc.data();

// --- Populate UI ---
      document.getElementById("memberName").textContent = memberData.name;
      document.getElementById("memberClass").textContent = memberData.class;
      document.getElementById("avatar").src =
        memberData.avatar || "https://i.imgur.com/Bo3ZY5vm.jpg";

      // Populate weekly history table
      updateHistoryTable();

      // Render chart
      renderChart();

      feather.replace();
    }

    // === üìä Update Chart ===
    let chartInstance = null;
    function renderChart() {
      const ctx = document.getElementById("progressChart").getContext("2d");
      const weeks = memberData.weeklyCP?.map(w => w.week) || [];
      const cpValues = memberData.weeklyCP?.map(w => w.cp) || [];

      if (chartInstance) chartInstance.destroy();
      chartInstance = new Chart(ctx, {
        type: "line",
        data: {
          labels: weeks,
          datasets: [{
            label: "Combat Power",
            data: cpValues,
            borderColor: "#fbbf24",
            backgroundColor: "rgba(251,191,36,0.15)",
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: false, grid: { color: "rgba(255,255,255,0.1)" } },
            x: { grid: { color: "rgba(255,255,255,0.1)" } }
          }
        }
      });
    }

    // === üìÖ Update History Table ===
    function updateHistoryTable() {
      const body = document.getElementById("historyBody");
      body.innerHTML = "";
      const weeks = memberData.weeklyCP || [];
      weeks.forEach((w, i) => {
        const tr = document.createElement("tr");
        tr.className = "border-b border-gray-700";
        tr.innerHTML = `
          <td class="py-2">${w.week}</td>
          <td class="py-2">${w.cp.toLocaleString()}</td>
          <td class="py-2 ${w.growth >= 0 ? 'text-green-400' : 'text-red-400'}">
            ${w.growth >= 0 ? '+' : ''}${w.growth.toLocaleString()}
          </td>
        `;
        body.appendChild(tr);
      });
    }

    // === üîÑ Update CP ===
document.getElementById("updateBtn").addEventListener("click", async () => {
  const newCP = parseInt(document.getElementById("updateCP").value);
  if (isNaN(newCP)) return alert("Please enter a valid CP value.");

  const oldCP = memberData.cp || 0;
  const growth = newCP - oldCP;

  // Get current week label in "Mon-DD - Mon-DD" format
  const weekLabel = getCurrentWeekLabel();

  let weeklyCP = memberData.weeklyCP || [];

  // Update or create entry for current week
  const existingWeek = weeklyCP.find(w => w.week === weekLabel);
  if (existingWeek) {
    existingWeek.cp = newCP;
    existingWeek.growth = growth;
  } else {
    weeklyCP.push({ week: weekLabel, cp: newCP, growth });
  }

  // Keep only last 4 weeks
  if (weeklyCP.length > 4) weeklyCP = weeklyCP.slice(-4);

  // Update Firestore
  await membersRef.doc(memberId).update({
    cp: newCP,
    growth,
    weeklyCP
  });

  alert(`‚úÖ Combat Power updated to ${newCP.toLocaleString()} (Growth: ${growth >= 0 ? '+' : ''}${growth})`);

  // Reload latest data
  memberData.cp = newCP;
  memberData.growth = growth;
  memberData.weeklyCP = weeklyCP;

  document.getElementById("updateCP").value = "";
  updateHistoryTable();
  renderChart();
});

    // === üóëÔ∏è Delete Member ===
    document.getElementById("deleteBtn").addEventListener("click", async () => {
      if (!confirm("Are you sure you want to delete this member?")) return;
      await membersRef.doc(memberId).delete();
      alert("üóëÔ∏è Member deleted successfully.");
      window.location.href = "index.html";
    });

    // Load on start
    loadMember();
  </script>
</body>
</html>