<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GuildPower Tracker</title>
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.globe.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@300;400;500;600;700&display=swap');
    .medieval-font { font-family: 'MedievalSharp', cursive; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .frosted-glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.1); }
    .class-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
    .cp-progress-bar { transition: width 0.5s ease-in-out; }
    .achievement-badge { animation: pulse 2s infinite; box-shadow: 0 0 15px rgba(255,215,0,0.5); }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
  </style>
</head>
<body class="bg-gray-900 text-white font-['Inter']">

  <!-- Navigation -->
  <nav class="bg-gray-800 py-4 px-6 flex justify-between items-center sticky top-0 z-50 shadow-lg">
    <div class="flex items-center space-x-2">
      <i data-feather="shield" class="text-yellow-400"></i>
      <h1 class="text-xl medieval-font">GuildPower Tracker</h1>
    </div>
    <div class="hidden md:flex space-x-6">
      <a href="#dashboard" class="hover:text-yellow-400 transition-colors">Dashboard</a>
      <a href="#members" class="hover:text-yellow-400 transition-colors">Members</a>
      <a href="#leaderboards" class="hover:text-yellow-400 transition-colors">Leaderboards</a>
      <a href="#admin" class="hover:text-yellow-400 transition-colors">Admin</a>
    </div>
    <button class="md:hidden">
      <i data-feather="menu"></i>
    </button>
  </nav>

  <!-- Hero Section -->
  <section id="hero" class="gradient-bg py-20 relative overflow-hidden">
    <div id="vanta-globe" class="absolute inset-0"></div>
    <div class="container mx-auto px-6 relative z-10">
      <div class="max-w-3xl mx-auto text-center">
        <h2 class="text-5xl md:text-6xl font-bold mb-6 medieval-font">CELESTIALS</h2>
        <p class="text-xl mb-8 text-gray-200">Track your guild's Combat Power progression and dominate the rankings!</p>
        <div class="flex flex-col sm:flex-row gap-4 justify-center">
          <a href="leaderboards.html" 
             class="frosted-glass border border-white/30 hover:bg-white/10 text-white font-bold py-3 px-8 rounded-lg transition-all inline-block">
             View Leaderboard
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Dashboard -->
  <section id="dashboard" class="py-16 bg-gray-800">
    <div class="container mx-auto px-6">
      <h2 class="text-3xl font-bold mb-12 text-center medieval-font">Guild Overview</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
        <div class="bg-gray-700 rounded-xl p-6 shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400">Total Members</p>
              <p class="text-3xl font-bold" id="total-members">0</p>
            </div>
            <i data-feather="users" class="text-yellow-400"></i>
          </div>
        </div>
        <div class="bg-gray-700 rounded-xl p-6 shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400">Avg CP</p>
              <p class="text-3xl font-bold" id="avg-cp">0</p>
            </div>
            <i data-feather="trending-up" class="text-green-400"></i>
          </div>
        </div>
        <div class="bg-gray-700 rounded-xl p-6 shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400">Top Growth</p>
              <p class="text-3xl font-bold" id="top-growth">0</p>
            </div>
            <i data-feather="award" class="text-purple-400"></i>
          </div>
        </div>
        <div class="bg-gray-700 rounded-xl p-6 shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400">Active Classes</p>
              <p class="text-3xl font-bold" id="active-classes">0</p>
            </div>
            <i data-feather="shield" class="text-blue-400"></i>
          </div>
        </div>
      </div>

      <!-- Weekly Progress Chart -->
      <div class="bg-gray-700 rounded-xl p-6 shadow-lg mb-12">
        <h3 class="text-xl font-bold mb-6">Weekly Guild CP Progress</h3>
        <div class="h-64">
          <canvas id="guildProgressChart"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- Members Section -->
  <section id="members" class="py-16 bg-gray-900">
    <div class="container mx-auto px-6">
      <h2 class="text-3xl font-bold mb-12 text-center medieval-font">Guild Members</h2>
      <div class="flex flex-wrap gap-2 mb-8 justify-center" id="class-filters">
        <!-- Class filters dynamically generated -->
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="members-grid">
        <!-- Members loaded from Firestore -->
      </div>
    </div>
  </section>

  <!-- Admin Section -->
  <section id="admin" class="py-16 bg-gray-900">
    <div class="container mx-auto px-6">
      <h2 class="text-3xl font-bold mb-12 text-center medieval-font">Admin Dashboard</h2>

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

        <!-- Add Member Form -->
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-6">Add New Member</h3>
          <form id="add-member-form" class="space-y-4">
            <input type="text" id="new-member-name" placeholder="Member Name" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3">
            <select id="new-member-class" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3">
              <option value="">Select Class</option>
              <option value="Bare Hand" data-color="bg-red-500">Bare Hand</option>
              <option value="Sword & Shield" data-color="bg-blue-500">Sword & Shield</option>
              <option value="Battle Staff" data-color="bg-purple-500">Battle Staff</option>
              <option value="Battle Shield" data-color="bg-green-500">Battle Shield</option>
              <option value="Great Sword" data-color="bg-yellow-500">Great Sword</option>
              <option value="Staff" data-color="bg-indigo-500">Staff</option>
              <option value="Dagger" data-color="bg-pink-500">Dagger</option>
              <option value="Bow" data-color="bg-teal-500">Bow</option>
              <option value="Crossbow" data-color="bg-orange-500">Crossbow</option>
            </select>
            <input type="number" id="new-member-cp" placeholder="Initial CP" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3">
            <input type="text" id="new-member-avatar" placeholder="Avatar URL" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3">
            <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg">Add Member</button>
          </form>
        </div>

        <!-- Update/Delete CP & Member -->
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4">Update / Delete Member</h3>

<!-- Update CP -->
          <form id="update-cp-form" class="space-y-4">
            <select id="update-member-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3" required>
              <option value="">Select Member</option>
            </select>
            <input type="number" id="update-cp-value" placeholder="New CP" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3" required>
            <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg">Update CP</button>
          </form>

          <!-- Delete Member -->
          <button id="delete-member-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg mt-4">Delete Selected Member</button>
        </div>

      </div>
    </div>
  </section>

  <!-- Firebase Config & Initialization -->
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDoim277EKmZDh0TnbZbK5OXy2GdVW-d84",
      authDomain: "guildcombatpower.firebaseapp.com",
      projectId: "guildcombatpower",
      storageBucket: "guildcombatpower.firebasestorage.app",
      messagingSenderId: "862355543279",
      appId: "1:862355543279:web:e7d7c1b5ee1f3ba89f371a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const membersRef = db.collection('members');

    // Default Avatars
    const defaultAvatars = {
      'Bow':'https://i.imgur.com/w8VJlOnm.jpg',
      'Crossbow':'https://i.imgur.com/Omci8iCm.jpg',
      'Staff':'https://i.imgur.com/Bo3ZY5vm.jpg',
      'Battle Shield':'https://i.imgur.com/YCpmOwTm.jpg',
      'Great Sword':'https://i.imgur.com/IHsuu5am.jpg',
      'Battle Staff':'https://i.imgur.com/xI1IKPsm.jpg',
      'Sword & Shield':'https://i.imgur.com/I4Rku2cm.jpg',
      'Dagger':'https://i.imgur.com/fzTxuszm.jpg',
      'Bare Hand':'https://i.imgur.com/Bo3ZY5vm.jpg'
    };

    // Populate Member Dropdowns
    function populateMemberDropdowns() {
      const updateSelect = document.getElementById('update-member-select');
      updateSelect.innerHTML = '<option value="">Select Member</option>';
      membersRef.get().then(snapshot => {
        snapshot.docs.forEach(doc => {
          const m = doc.data();
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = m.name;
          updateSelect.appendChild(option);
        });
      });
    }
    populateMemberDropdowns();

    // Add Member (with duplicate prevention & case-insensitive name)
document.getElementById('add-member-form').addEventListener('submit', async e => {
  e.preventDefault();
  const name = document.getElementById('new-member-name').value.trim();
  const cls = document.getElementById('new-member-class').value;
  const cp = parseInt(document.getElementById('new-member-cp').value);
  let avatar = document.getElementById('new-member-avatar').value.trim();
  if (!avatar) avatar = defaultAvatars[cls] || defaultAvatars['Bare Hand'];
  const color = document.querySelector(`#new-member-class option[value="${cls}"]`)?.dataset.color || 'bg-gray-500';
  if (!name || !cls || isNaN(cp)) return alert("Please fill in all fields.");

  try {
    // 🔍 Check for duplicate (case-insensitive)
    const snapshot = await membersRef.get();
    const exists = snapshot.docs.some(doc => {
      const data = doc.data();
      return data.name.toLowerCase() === name.toLowerCase() && data.class === cls;
    });

    if (exists) {
      alert("⚠️ A member with this name and class already exists!");
      return;
    }

    // ✅ Add new member
    await membersRef.add({
      name: name,
      class: cls,
      classColor: color,
      cp: cp,
      growth: 0,
      weeklyCP: [{ week: 'Week 1', cp: cp, growth: 0, rank: '-' }],
      avatar: avatar
    });

    alert("✅ Member added successfully!");
    document.getElementById('add-member-form').reset();
    populateMemberDropdowns();
    updateLeaderboards();

  } catch (error) {
    console.error("Error adding member:", error);
    alert("❌ Failed to add member. Check console for details.");
  }
});

    // Update CP
    document.getElementById('update-cp-form').addEventListener('submit', e => {
      e.preventDefault();
      const memberId = document.getElementById('update-member-select').value;
      const newCP = parseInt(document.getElementById('update-cp-value').value);
      if(!memberId || isNaN(newCP)) return alert("Select member and enter valid CP");

      const memberDoc = membersRef.doc(memberId);
      memberDoc.get().then(doc => {
        if(!doc.exists) return alert("Member not found");
        const data = doc.data();
        const oldCP = data.cp || 0;
        const growth = newCP - oldCP;
        const weekNum = (data.weeklyCP?.length || 0) + 1;
        const weeklyCP = [...(data.weeklyCP || []), { week:'Week ' + weekNum, cp:newCP, growth:growth, rank:'-' }];
        memberDoc.update({ cp:newCP, growth:growth, weeklyCP:weeklyCP }).then(() => {
          alert(`CP updated! Growth: ${growth}`);
          document.getElementById('update-cp-form').reset();
          populateMemberDropdowns();
          updateLeaderboards();
        });
      });
    });

    // Delete Member
    document.getElementById('delete-member-btn').addEventListener('click', () => {
      const memberId = document.getElementById('update-member-select').value;
      if(!memberId) return alert("Select a member to delete");
      if(!confirm("Are you sure you want to delete this member?")) return;

      membersRef.doc(memberId).delete().then(() => {
        alert("Member deleted!");
        populateMemberDropdowns();
        updateLeaderboards();
      });
    });

    // Update Leaderboards & Members Grid
    const totalMembersEl = document.getElementById('total-members');
    const avgCPEl = document.getElementById('avg-cp');
    const topGrowthEl = document.getElementById('top-growth');
    const activeClassesEl = document.getElementById('active-classes');
    const membersGrid = document.getElementById('members-grid');

    function updateLeaderboards() {
      membersRef.get().then(snapshot => {
        const members = snapshot.docs.map(doc => ({id:doc.id,...doc.data()}));
        totalMembersEl.textContent = members.length;
        avgCPEl.textContent = members.length ? Math.round(members.reduce((a,b)=>a+b.cp,0)/members.length).toLocaleString() : 0;
        topGrowthEl.textContent = members.length ? Math.max(...members.map(m=>m.growth||0)).toLocaleString() : 0;
        const activeClasses = [...new Set(members.map(m=>m.class))];
        activeClassesEl.textContent = activeClasses.length + '/9';

        // Sort by CP for rank
        const totalCPRanked = [...members].sort((a,b)=>b.cp-a.cp);
        totalCPRanked.forEach((m,i)=>membersRef.doc(m.id).update({rank:i+1}));

        // Render members grid
        membersGrid.innerHTML = members.map(m => `
          <div class="bg-gray-800 rounded-xl p-6 shadow-lg hover:shadow-xl transition-all">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center space-x-3">
                <img src="${m.avatar || defaultAvatars[m.class] || defaultAvatars['Bare Hand']}" alt="${m.name}" class="w-12 h-12 rounded-full">
                <div>
                  <h4 class="font-bold">${m.name}</h4>
                  <span class="class-badge ${m.classColor} text-white">${m.class}</span>
                </div>
              </div>
              <div class="achievement-badge bg-yellow-500 text-gray-900 rounded-full p-2">
                <i data-feather="star"></i>
              </div>
            </div>
            <div class="mb-4">
              <div class="flex justify-between text-sm mb-1">
                <span>Current CP: ${m.cp.toLocaleString()}</span>
                <span class="text-green-400">${m.growth>=0 ? '+' : ''}${(m.growth||0).toLocaleString()}</span>
              </div>
              <div class="w-full bg-gray-700 rounded-full h-2">
                <div class="cp-progress-bar bg-green-500 h-2 rounded-full" style="width:${Math.min(100,(m.cp/20000)*100)}%"></div>
              </div>
            </div>
            <button class="w-full bg-gray-700 hover:bg-gray-600 py-2 rounded-lg transition-colors" onclick="viewMemberDetail('${m.id}')">View Progress</button>
          </div>
        `).join('');

        feather.replace();
      });
    }
    updateLeaderboards();
    setInterval(updateLeaderboards,10000);

    function viewMemberDetail(memberId){
      window.location.href = `members-detail.html?id=${memberId}`;
    }

    // Guild Progress Chart
    const guildCtx = document.getElementById('guildProgressChart').getContext('2d');
    const guildProgressChart = new Chart(guildCtx, {
      type:'line',
      data:{labels:['Week 1','Week 2','Week 3','Week 4','Week 5'], datasets:[{label:'Average Guild CP', data:[0,0,0,0,0], borderColor:'#fbbf24', backgroundColor:'rgba(251,191,36,0.1)', tension:0.4, fill:true}]},
      options:{responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:false, grid:{color:'rgba(255,255,255,0.1)'}}, x:{grid:{color:'rgba(255,255,255,0.1)'}}}}
    });

    function updateGuildChart(){
      membersRef.get().then(snapshot=>{
        const members = snapshot.docs.map(doc=>doc.data());
        const weeks = 5;
        const avgCPPerWeek = [];
        for(let w=0; w<weeks; w++){
          const weekCPs = members.map(m => (m.weeklyCP && m.weeklyCP[w]?.cp)||0);
          const avg = weekCPs.length ? Math.round(weekCPs.reduce((a,b)=>a+b,0)/weekCPs.length) : 0;
          avgCPPerWeek.push(avg);
        }
        guildProgressChart.data.datasets[0].data = avgCPPerWeek;
        guildProgressChart.update();
      });
    }
    updateGuildChart();
    setInterval(updateGuildChart,10000);

    // Vanta Globe
    VANTA.GLOBE({ el:"#vanta-globe", mouseControls:true, touchControls:true, gyroControls:false, minHeight:200, minWidth:200, scale:1, scaleMobile:1, color:0xffd700, backgroundColor:0x667eea });

    // Mobile Menu Toggle
    document.querySelector('button.md\\:hidden').addEventListener('click',function(){
      const nav=document.querySelector('.hidden.md\\:flex');
      nav.classList.toggle('hidden');
      nav.classList.toggle('flex');
      nav.classList.toggle('flex-col');
      nav.classList.toggle('absolute');
      nav.classList.toggle('top-16');
      nav.classList.toggle('left-0');
      nav.classList.toggle('right-0');
      nav.classList.toggle('bg-gray-800');
      nav.classList.toggle('p-4');
      nav.classList.toggle('space-y-4');
    });
</script>
</body>
</html>