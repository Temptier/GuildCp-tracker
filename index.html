<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GuildPower Tracker</title>
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://unpkg.com/feather-icons"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vanta@latest/dist/vanta.globe.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=MedievalSharp&family=Inter:wght@300;400;500;600;700&display=swap');
    .medieval-font { font-family: 'MedievalSharp', cursive; }
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .frosted-glass { backdrop-filter: blur(10px); background: rgba(255,255,255,0.1); }
    .class-badge { padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; }
    .cp-progress-bar { transition: width 0.5s ease-in-out; }
    .achievement-badge { animation: pulse 2s infinite; box-shadow: 0 0 15px rgba(255,215,0,0.5); }
    @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
  </style>
</head>
<body class="bg-gray-900 text-white font-['Inter']">
  <!-- Navigation -->
  <nav class="bg-gray-800 py-4 px-6 flex justify-between items-center sticky top-0 z-50 shadow-lg">
    <div class="flex items-center space-x-2">
      <i data-feather="shield" class="text-yellow-400"></i>
      <h1 class="text-xl medieval-font">Guild Power Tracker</h1>
    </div>
    <div class="hidden md:flex space-x-6">
      <a href="#dashboard" class="hover:text-yellow-400 transition-colors">Dashboard</a>
      <a href="#members" class="hover:text-yellow-400 transition-colors">Members</a>
      <a href="#admin" class="hover:text-yellow-400 transition-colors">Admin</a>
    </div>
    <button class="md:hidden">
      <i data-feather="menu"></i>
    </button>
  </nav>

  <!-- Hero Section -->
  <section id="hero" class="gradient-bg py-20 relative overflow-hidden">
    <div id="vanta-globe" class="absolute inset-0"></div>
    <div class="container mx-auto px-6 relative z-10">
      <div class="max-w-3xl mx-auto text-center">
        <h2 class="text-5xl md:text-6xl font-bold mb-6 medieval-font">CELESTIALS</h2>
        <p class="text-xl mb-8 text-gray-200">Track your guild's Combat Power progression and dominate the rankings!</p>
      </div>
    </div>
  </section>

  <!-- Dashboard -->
  <section id="dashboard" class="py-16 bg-gray-800">
    <div class="container mx-auto px-6">
      <h2 class="text-3xl font-bold mb-12 text-center medieval-font">Guild Overview</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
        <div class="bg-gray-700 rounded-xl p-6 shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400">Total Members</p>
              <p class="text-3xl font-bold" id="total-members">0</p>
            </div>
            <i data-feather="users" class="text-yellow-400"></i>
          </div>
        </div>
        <div class="bg-gray-700 rounded-xl p-6 shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400">Avg CP</p>
              <p class="text-3xl font-bold" id="avg-cp">0</p>
            </div>
            <i data-feather="trending-up" class="text-green-400"></i>
          </div>
        </div>
        <div class="bg-gray-700 rounded-xl p-6 shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400">Top Growth</p>
              <p class="text-3xl font-bold" id="top-growth">0</p>
            </div>
            <i data-feather="award" class="text-purple-400"></i>
          </div>
        </div>
        <div class="bg-gray-700 rounded-xl p-6 shadow-lg">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-gray-400">Active Classes</p>
              <p class="text-3xl font-bold" id="active-classes">0</p>
            </div>
            <i data-feather="shield" class="text-blue-400"></i>
          </div>
        </div>
      </div>

      <!-- Weekly Progress Chart -->
      <div class="bg-gray-700 rounded-xl p-6 shadow-lg mb-12">
        <h3 class="text-xl font-bold mb-6">Weekly Guild CP Progress</h3>
        <div class="h-64">
          <canvas id="guildProgressChart"></canvas>
        </div>
      </div>
    </div>
  </section>

  <!-- Members Section -->
  <section id="members" class="py-16 bg-gray-900">
    <div class="container mx-auto px-6">
      <h2 class="text-3xl font-bold mb-12 text-center medieval-font">Guild Members</h2>
      <div class="flex flex-wrap gap-2 mb-8 justify-center" id="class-filters"></div>
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="members-grid"></div>
    </div>
  </section>

<!-- Admin Section -->
  <section id="admin" class="py-16 bg-gray-900">
    <div class="container mx-auto px-6">
      <h2 class="text-3xl font-bold mb-12 text-center medieval-font">Admin Dashboard</h2>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Add Member Form -->
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-6">Add New Member</h3>
          <form id="add-member-form" class="space-y-4">
            <input type="text" id="new-member-name" placeholder="Member Name" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3">
            <select id="new-member-class" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3">
              <option value="">Select Class</option>
              <option value="Bare Hand" data-color="bg-red-500">Bare Hand</option>
              <option value="Sword & Shield" data-color="bg-blue-500">Sword & Shield</option>
              <option value="Battle Staff" data-color="bg-purple-500">Battle Staff</option>
              <option value="Battle Shield" data-color="bg-green-500">Battle Shield</option>
              <option value="Great Sword" data-color="bg-yellow-500">Great Sword</option>
              <option value="Staff" data-color="bg-indigo-500">Staff</option>
              <option value="Dagger" data-color="bg-pink-500">Dagger</option>
              <option value="Bow" data-color="bg-teal-500">Bow</option>
              <option value="Crossbow" data-color="bg-orange-500">Crossbow</option>
            </select>
            <input type="number" id="new-member-cp" placeholder="Initial CP" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3">
            <input type="text" id="new-member-avatar" placeholder="Avatar URL (optional)" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3">
            <button type="submit" class="w-full bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 rounded-lg">Add Member</button>
          </form>
        </div>

        <!-- Update/Delete CP & Member -->
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg">
          <h3 class="text-xl font-bold mb-4">Update / Delete Member</h3>
          <form id="update-cp-form" class="space-y-4">
            <select id="update-member-select" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3" required>
              <option value="">Select Member</option>
            </select>
            <input type="number" id="update-cp-value" placeholder="New CP" class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3" required>
            <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg">Update CP</button>
          </form>
          <button id="delete-member-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg mt-4">Delete Selected Member</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Member Detail Modal -->
  <div id="memberModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm hidden items-center justify-center z-50">
    <div class="bg-gray-800 rounded-xl shadow-lg max-w-lg w-full p-6 relative">
      <button id="closeModal" class="absolute top-3 right-3 text-gray-300 hover:text-white text-xl font-bold">&times;</button>
      <div class="flex flex-col items-center space-y-4">
        <img id="modalAvatar" src="" alt="Avatar" class="w-24 h-24 rounded-full border-2 border-yellow-400">
        <h2 id="modalName" class="text-2xl font-bold medieval-font">Member Name</h2>
        <span id="modalClass" class="class-badge bg-blue-500 text-white">Class</span>
        <p class="mt-2">Current CP: <span id="modalCP">0</span> | Growth: <span id="modalGrowth">0</span></p>
      </div>
      <div class="mt-6 h-48">
        <canvas id="modalChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Firebase & Scripts -->
  <script>
    // Firebase Config
   const firebaseConfig = {


  apiKey: "AIzaSyBB5jYS6FPjPDtMUkx8PxcZamOtcq5WDzQ",


  authDomain: "combattracker-86058.firebaseapp.com",


  projectId: "combattracker-86058",


  storageBucket: "combattracker-86058.firebasestorage.app",


  messagingSenderId: "383727173287",


  appId: "1:383727173287:web:71f4181a5df121bb2a2582"


};
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const membersRef = db.collection('members');

    const defaultAvatars = {
      'Bow':'https://i.imgur.com/w8VJlOnm.jpg',
      'Crossbow':'https://i.imgur.com/Omci8iCm.jpg',
      'Staff':'https://i.imgur.com/Bo3ZY5vm.jpg',
      'Battle Shield':'https://i.imgur.com/YCpmOwTm.jpg',
      'Great Sword':'https://i.imgur.com/IHsuu5am.jpg',
      'Battle Staff':'https://i.imgur.com/xI1IKPsm.jpg',
      'Sword & Shield':'https://i.imgur.com/I4Rku2cm.jpg',
      'Dagger':'https://i.imgur.com/fzTxuszm.jpg',
      'Bare Hand':'https://i.imgur.com/Bo3ZY5vm.jpg'
    };

    // Cache members locally
    let membersCache = [];

    // Populate Update Dropdown
    async function populateMemberDropdowns() {
      const select = document.getElementById('update-member-select');
      select.innerHTML = '<option value="">Select Member</option>';
      const snapshot = await membersRef.get();
      snapshot.docs.forEach(doc=>{
        const m = doc.data();
        const option = document.createElement('option');
        option.value = doc.id;
        option.textContent = m.name;
        select.appendChild(option);
      });
    }
    populateMemberDropdowns();

    // Add Member
    document.getElementById('add-member-form').addEventListener('submit', async e=>{
      e.preventDefault();
      const name = document.getElementById('new-member-name').value.trim();
      const cls = document.getElementById('new-member-class').value;
      const cp = parseInt(document.getElementById('new-member-cp').value);
      let avatar = document.getElementById('new-member-avatar').value.trim();
      if(!avatar) avatar = defaultAvatars[cls]||defaultAvatars['Bare Hand'];
      const color = document.querySelector(`#new-member-class option[value="${cls}"]`)?.dataset.color||'bg-gray-500';
      if(!name||!cls||isNaN(cp)) return alert("Fill all fields");

      const snapshot = await membersRef.get();
      const exists = snapshot.docs.some(doc=>doc.data().name.toLowerCase()===name.toLowerCase() && doc.data().class===cls);
      if(exists) return alert("Member exists!");

      const weekLabel = getWeekLabel();
      await membersRef.add({ name, class:cls, classColor:color, cp, growth:0, weeklyCP:[{week:weekLabel, cp, growth:0}], avatar });
      alert("Member added!");
      e.target.reset();
      populateMemberDropdowns();
      loadMembers();
    });

    // Update CP
    document.getElementById('update-cp-form').addEventListener('submit', async e=>{
      e.preventDefault();
      const id = document.getElementById('update-member-select').value;
      const newCP = parseInt(document.getElementById('update-cp-value').value);
      if(!id||isNaN(newCP)) return alert("Select member and enter CP");

      const doc = await membersRef.doc(id).get();
      if(!doc.exists) return alert("Member not found!");
      const data = doc.data();
      const growth = newCP - (data.cp||0);
      const weekLabel = getWeekLabel();

      let weeklyCP = data.weeklyCP||[];
      const existing = weeklyCP.find(w=>w.week===weekLabel);
      if(existing){ existing.cp=newCP; existing.growth=growth; }
      else { weeklyCP.push({week:weekLabel, cp:newCP, growth}); }
      if(weeklyCP.length>4) weeklyCP = weeklyCP.slice(-4);

      await membersRef.doc(id).update({cp:newCP, growth, weeklyCP});
      alert(`Updated CP to ${newCP} (Growth: ${growth>=0?'+':''}${growth})`);
      document.getElementById('update-cp-value').value="";
      loadMembers();
    });

    // Delete Member
    document.getElementById('delete-member-btn').addEventListener('click', async ()=>{
      const id = document.getElementById('update-member-select').value;
      if(!id) return alert("Select member");
      if(!confirm("Delete member?")) return;
      await membersRef.doc(id).delete();
      alert("Deleted");
      populateMemberDropdowns();
      loadMembers();
    });

    // Week Label Helper
    function getWeekLabel(){
      const now = new Date();
      const day = now.getDay();
      const sunday = new Date(now); sunday.setDate(now.getDate()-day);
      const saturday = new Date(sunday); saturday.setDate(sunday.getDate()+6);
      const format = d=>d.toLocaleDateString('en-US',{month:'short', day:'numeric'});
      return `${format(sunday)} - ${format(saturday)}`;
    }

    // Load Members and update dashboard
    async function loadMembers(){
      const snapshot = await membersRef.get();
      membersCache = snapshot.docs.map(doc=>({id:doc.id,...doc.data()}));

      // Dashboard
      document.getElementById('total-members').textContent = membersCache.length;
      document.getElementById('avg-cp').textContent = membersCache.length?Math.round(membersCache.reduce((a,b)=>a+b.cp,0)/membersCache.length).toLocaleString():0;
      document.getElementById('top-growth').textContent = membersCache.length?Math.max(...membersCache.map(m=>m.growth||0)).toLocaleString():0;
      document.getElementById('active-classes').textContent = [...new Set(membersCache.map(m=>m.class))].length+'/9';

      // Members grid
      const grid = document.getElementById('members-grid');
      grid.innerHTML = membersCache.map(m=>`
        <div class="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-400 cursor-pointer hover:shadow-xl transition-all" onclick="viewMember('${m.id}')">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center space-x-3">
              <img src="${m.avatar||defaultAvatars[m.class]}" alt="${m.name}" class="w-12 h-12 rounded-full">
              <div>
                <h4 class="font-bold">${m.name}</h4>
                <span class="class-badge ${m.classColor} text-white">${m.class}</span>
              </div>
            </div>
            <div class="achievement-badge bg-yellow-500 text-gray-900 rounded-full p-2">
              <i data-feather="star"></i>
            </div>
          </div>
          <div class="mb-4">
            <div class="flex justify-between text-sm mb-1">
              <span>Current CP: ${m.cp.toLocaleString()}</span>
              <span class="text-green-400">${m.growth>=0?'+':''}${(m.growth||0).toLocaleString()}</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2">
              <div class="cp-progress-bar bg-green-500 h-2 rounded-full" style="width:${Math.min(100,(m.cp/20000)*100)}%"></div>
            </div>
          </div>
        </div>
      `).join('');
      feather.replace();
    }
    loadMembers();

    // === View Member in Modal ===
    let modalChartInstance = null;
    function viewMember(id){
      const m = membersCache.find(x=>x.id===id);
      if(!m) return;

      document.getElementById('modalAvatar').src = m.avatar||defaultAvatars[m.class];
      document.getElementById('modalName').textContent = m.name;
      document.getElementById('modalClass').textContent = m.class;
      document.getElementById('modalCP').textContent = m.cp.toLocaleString();
      document.getElementById('modalGrowth').textContent = (m.growth>=0?'+':'')+m.growth.toLocaleString();

      const ctx = document.getElementById('modalChart').getContext('2d');
      const weeks = m.weeklyCP?.map(w=>w.week)||[];
      const cpValues = m.weeklyCP?.map(w=>w.cp)||[];

      if(modalChartInstance) modalChartInstance.destroy();
      modalChartInstance = new Chart(ctx,{
        type:'line',
        data:{ labels:weeks, datasets:[{label:'CP', data:cpValues, borderColor:'#fbbf24', backgroundColor:'rgba(251,191,36,0.15)', tension:0.4, fill:true }]},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:false},x:{grid:{color:"rgba(255,255,255,0.1)"}}} }
      });

      document.getElementById('memberModal').classList.remove('hidden');
      document.getElementById('memberModal').classList.add('flex');
    }

    document.getElementById('closeModal').addEventListener('click',()=>{
      document.getElementById('memberModal').classList.add('hidden');
      document.getElementById('memberModal').classList.remove('flex');
    });

    // Optional: close modal when clicking outside
    document.getElementById('memberModal').addEventListener('click', (e)=>{
      if(e.target.id==='memberModal'){
        document.getElementById('memberModal').classList.add('hidden');
        document.getElementById('memberModal').classList.remove('flex');
      }
    });

  </script>
</body>
</html>